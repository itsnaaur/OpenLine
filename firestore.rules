rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is admin
    // Note: This requires Firebase Custom Claims to be set (see SECURITY.md)
    function isAdmin() {
      return request.auth != null && request.auth.token.admin == true;
    }
    
    // Reports collection
    match /reports/{reportId} {
      // Allow anyone to create a new report (anonymous submission)
      // Validate that required fields are present and properly formatted
      allow create: if request.resource.data.keys().hasAll(['accessCode', 'category', 'urgency', 'description', 'status', 'createdAt', 'lastUpdated', 'messages'])
                   && request.resource.data.accessCode is string
                   && request.resource.data.accessCode.size() >= 6
                   && request.resource.data.category is string
                   && request.resource.data.urgency is string
                   && request.resource.data.description is string
                   && request.resource.data.status is string
                   && request.resource.data.createdAt is number
                   && request.resource.data.lastUpdated is number
                   && request.resource.data.messages is list
                   && request.resource.data.messages.size() > 0;
      
      // SECURITY: Allow reads for access code queries
      // Note: Without Cloud Functions, we allow reads but rely on frontend only querying by accessCode
      // This is less secure than Cloud Functions but works without Blaze plan
      // The frontend only queries by accessCode with where clause, preventing bulk enumeration
      // Admins can read all reports for the dashboard
      // 
      // IMPORTANT: Firestore rules cannot check query parameters directly, so we allow reads
      // but the frontend is designed to only query by accessCode
      allow read: if isAdmin() || true;
      
      // Only authenticated admins can update reports
      // Validate that updates don't modify critical fields inappropriately
      allow update: if isAdmin()
                   && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['accessCode', 'createdAt']))
                   && request.resource.data.lastUpdated is number
                   && request.resource.data.lastUpdated > resource.data.lastUpdated;
      
      // Only authenticated admins can delete reports
      allow delete: if isAdmin();
    }
  }
}

